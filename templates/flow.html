{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col p-8 overflow-hidden">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Simulador Operacional</h1>
            <p class="text-slate-400">Visão sistêmica do fluxo: Recebimento &rarr; Expedição</p>
        </div>
        <div class="flex gap-4">
            <span class="flex items-center gap-2 text-xs text-slate-400">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Operando
            </span>
            <span class="flex items-center gap-2 text-xs text-slate-400">
                <span class="w-2 h-2 rounded-full bg-yellow-500"></span> Atenção
            </span>
            <span class="flex items-center gap-2 text-xs text-slate-400">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> Crítico
            </span>
        </div>
    </div>

    <!-- Macro Flow Container -->
    <div class="flex-1 flex items-center justify-center relative">
        <!-- Connecting Line (Background) -->
        <div class="absolute top-1/2 left-10 right-10 h-1 bg-slate-800 -z-10 rounded-full"></div>

        <!-- Sectors Grid -->
        <div class="flex gap-8 overflow-x-auto pb-8 pt-4 px-4 w-full justify-between items-center mask-linear">
            {% for name, data in sectors.items() %}
            <div class="relative group cursor-pointer" onclick="openSectorDetails('{{ name }}')">

                <!-- Connection Dot -->
                <div class="absolute top-1/2 -left-4 w-2 h-2 bg-slate-700 rounded-full -translate-y-1/2"></div>

                <!-- Card -->
                <div
                    class="w-64 bg-slate-800/60 backdrop-blur-xl border 
                            {% if data.status == 'critical' %}border-red-500/50 shadow-[0_0_20px_rgba(239,68,68,0.2)]{% elif data.status == 'warning' %}border-yellow-500/50{% else %}border-emerald-500/30{% endif %} 
                            p-5 rounded-3xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden group">

                    <!-- Scanline Effect (Hologram) -->
                    <div
                        class="absolute inset-0 bg-gradient-to-b from-transparent via-white/5 to-transparent translate-y-[-100%] group-hover:translate-y-[100%] transition-transform duration-1000 pointer-events-none">
                    </div>

                    <!-- Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-white font-bold text-lg leading-tight">{{ name }}</h3>
                            <span class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold">Setor {{
                                loop.index }}</span>
                        </div>
                        <!-- Status Pulse -->
                        <div class="relative flex h-3 w-3">
                            {% if data.status == 'critical' %}
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            {% elif data.status == 'warning' %}
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                            {% else %}
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Main KPI Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Headcount Radial (Simulated with CSS) -->
                        <div class="relative flex items-center justify-center p-2">
                            <!-- Ring BG -->
                            <svg class="w-16 h-16 transform -rotate-90">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent"
                                    class="text-slate-700" />
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent"
                                    class="{% if data.status == 'critical' %}text-red-500{% elif data.status == 'warning' %}text-yellow-500{% else %}text-emerald-500{% endif %}"
                                    stroke-dasharray="175"
                                    stroke-dashoffset="{{ 175 - (data.count / data.target * 175) }}" />
                            </svg>
                            <div class="absolute text-center">
                                <span class="block text-xl font-bold text-white">{{ data.count }}</span>
                                <span class="block text-[9px] text-slate-400">/{{ data.target }}</span>
                            </div>
                        </div>

                        <!-- Data Points -->
                        <div class="space-y-2 flex flex-col justify-center">
                            <div>
                                <span class="text-[10px] text-slate-400 uppercase">Produtividade</span>
                                <div class="text-white font-mono text-sm">98<span
                                        class="text-slate-500 text-xs">%</span></div>
                            </div>
                            <div>
                                <span class="text-[10px] text-slate-400 uppercase">Gargalo</span>
                                <div
                                    class="{% if data.status == 'critical' %}text-red-400{% else %}text-emerald-400{% endif %} font-mono text-sm">
                                    {% if data.status == 'critical' %}Alto{% else %}Baixo{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Avatar Stack (Collaborators) -->
                    <div class="flex items-center justify-between border-t border-white/5 pt-3">
                        <div class="flex -space-x-2 overflow-hidden">
                            {% for person in data.people[:4] %}
                            <div class="inline-block h-6 w-6 rounded-full ring-2 ring-slate-800 bg-slate-600 flex items-center justify-center text-[8px] text-white font-bold uppercase"
                                title="{{ person.name }}">
                                {{ person.name[:2] }}
                            </div>
                            {% endfor %}
                            {% if data.count > 4 %}
                            <div
                                class="inline-block h-6 w-6 rounded-full ring-2 ring-slate-800 bg-slate-700 flex items-center justify-center text-[8px] text-slate-300 font-bold">
                                +{{ data.count - 4 }}
                            </div>
                            {% endif %}
                        </div>
                        <div
                            class="text-[10px] text-blue-400 hover:text-blue-300 transition-colors uppercase font-bold tracking-wider flex items-center gap-1">
                            Detalhes <span class="text-xs">&rarr;</span>
                        </div>
                    </div>
                </div>

                <!-- Connect Dot Right -->
                <div class="absolute top-1/2 -right-4 w-2 h-2 bg-slate-700 rounded-full -translate-y-1/2"></div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Details Modal Interface (Placeholder) -->
<div id="sectorModal"
    class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-8">
    <div class="bg-slate-900 w-full h-full rounded-3xl border border-slate-700 flex flex-col relative overflow-hidden"
        id="modalContainer">
        <!-- Close -->
        <button onclick="document.getElementById('sectorModal').classList.add('hidden')"
            class="absolute top-6 right-6 p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white z-10 hover:bg-red-500/20 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Dynamic Content -->
        <div class="flex-1 flex" id="modalContent"></div>
    </div>
</div>

<script>
    // Config: Micro-flows per Sector
    const SECTOR_FLOWS = {
        "Recebimento": ["Descarga", "Conferência", "Triagem Inicial", "Armazenagem"],
        "Câmara Fria": ["Organização", "Abastecimento Linha", "Retirada", "Inventário"],
        "Seleção": ["Alimentação", "Qualidade", "Classificação", "Descarte"],
        "Blocado": ["Quebra", "Reembalagem", "Padronização"],
        "Embandejamento": ["Montagem", "Selagem", "Etiquetagem", "Paletização"],
        "Estoque": ["Auditoria", "Separação", "Movimentação"],
        "Expedição": ["Picking", "Conferência", "Montagem Carga", "Doca"]
    };

    // Real Data Injected from Backend
    const SECTOR_DATA = {
        {% for sec_name, sec_data in sectors.items() %}
    "{{ sec_name }}": [
        {% for emp in sec_data.people %}
    {
        name: "{{ emp.name }}",
            role: "{{ emp.role }}",
                initials: "{{ emp.name[:2] }}",
                    id: { { emp.id } }
    },
    {% endfor %}
        ],
    {% endfor %}
    };

    function openSectorDetails(sectorName) {
        document.getElementById('sectorModal').classList.remove('hidden');
        renderModalContent(sectorName);
    }

    function renderModalContent(sectorName) {
        const flowSteps = SECTOR_FLOWS[sectorName] || ["Geral"];
        // Use Real Data or Fallback to empty array
        const team = SECTOR_DATA[sectorName] || [];

        // HTML Structure
        const html = `
            <!-- Sidebar: Team Pool -->
            <div class="w-80 bg-slate-850/50 border-r border-slate-700 p-6 overflow-y-auto">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white mb-1">${sectorName}</h2>
                    <p class="text-xs text-slate-400 uppercase tracking-widest font-semibold flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        Operação Ativa
                    </p>
                </div>

                <div class="mb-6 bg-slate-800 rounded-xl p-4 border border-slate-700">
                    <span class="text-xs text-slate-400 uppercase">Eficiência Atual</span>
                    <div class="text-3xl font-mono text-white mt-1">92%</div>
                    <div class="h-1 bg-slate-700 mt-2 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500 w-[92%]"></div>
                    </div>
                </div>

                <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase">Equipe Disponível (${team.length})</h3>
                <div class="grid grid-cols-2 gap-3" id="teamPool" ondrop="drop(event)" ondragover="allowDrop(event)">
                    ${team.map(emp => createDraggableAvatar(emp)).join('')}
                    ${team.length === 0 ? '<div class="col-span-2 text-slate-500 text-xs italic">Nenhum colaborador neste setor.</div>' : ''}
                </div>
            </div>

            <!-- Main Area: Micro-flow -->
            <div class="flex-1 bg-slate-900 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] p-10 flex flex-col items-center justify-center relative">
                
                <!-- Flow Chart container -->
                <div class="flex items-center gap-8 w-full max-w-5xl overflow-x-auto pb-4">
                    ${flowSteps.map((step, index) => `
                        <div class="flex items-center">
                            <!-- Step Node -->
                            <div class="flex flex-col items-center gap-4">
                                <div class="w-48 bg-slate-800/80 backdrop-blur border border-slate-600 rounded-2xl p-4 min-h-[200px] flex flex-col transition-colors hover:border-blue-500/50"
                                     ondrop="drop(event)" ondragover="allowDrop(event)" id="step-${index}">
                                    
                                    <!-- Node Header -->
                                    <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                                        <span class="text-sm font-bold text-white">${step}</span>
                                        <span class="text-[10px] text-slate-500 bg-slate-900 px-2 py-0.5 rounded">Etapa ${index + 1}</span>
                                    </div>
                                    
                                    <!-- Drop Zone Content -->
                                    <div class="flex-1 grid grid-cols-2 gap-2 content-start drop-target min-h-[100px]">
                                        <!-- Dropped items appear here -->
                                        <div class="text-xs text-slate-600 italic text-center col-span-2 py-4 border-2 border-dashed border-slate-700/50 rounded-lg pointer-events-none empty-msg">
                                            Arraste aqui
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Connector Arrow (except last) -->
                            ${index < flowSteps.length - 1 ? `
                            <div class="w-12 h-0.5 bg-slate-700 relative mx-2">
                                <div class="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 border-t-2 border-r-2 border-slate-700 rotate-45"></div>
                            </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                 <!-- Simulation Alert (Bottom) -->
                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur border border-yellow-500/30 px-6 py-3 rounded-full flex items-center gap-3 shadow-2xl translate-y-20 animate-slide-up">
                    <span class="text-yellow-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </span>
                    <span class="text-sm text-slate-200">
                        Simulação: <strong class="text-white">Gargalo detectado em ${flowSteps[1] || 'Processo'}</strong> (-12% Flow)
                    </span>
                </div>
            </div>
        `;

        document.getElementById('modalContent').innerHTML = html;

        // Trigger CSS animation for alert
        setTimeout(() => document.querySelector('.animate-slide-up').classList.remove('translate-y-20'), 500);
    }

    function createDraggableAvatar(emp) {
        return `
            <div class="bg-slate-700/50 p-2 rounded-lg flex items-center gap-3 cursor-grab hover:bg-slate-700 border border-transparent hover:border-slate-500 transition-all select-none"
                 draggable="true" 
                 onstart="drag(event)" 
                 id="emp-${emp.initials}">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-xs font-bold text-white shadow-lg">
                    ${emp.initials}
                </div>
                <div class="overflow-hidden">
                    <p class="text-xs font-bold text-white truncate">${emp.name}</p>
                    <p class="text-[10px] text-slate-400 truncate">${emp.role}</p>
                </div>
            </div>
        `;
    }

    // Drag & Drop Logic
    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('bg-slate-700/20');
    }

    function drag(ev) {
        // Find the draggable element (could be clicking child)
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        var draggedEl = document.getElementById(data);

        // Find closest valid drop target
        // We want to drop inside the 'drop-target' div inside the Step Card, OR back to 'teamPool'
        let target = ev.target.closest('.drop-target') || ev.target.closest('#teamPool');

        if (target) {
            // Remove "Arraste aqui" msg if exists
            const emptyMsg = target.querySelector('.empty-msg');
            if (emptyMsg) emptyMsg.style.display = 'none';

            target.appendChild(draggedEl);

            // Simple visual feedback
            draggedEl.classList.add('scale-100'); // Reset potential scale effects

            // Re-simulate (Mock)
            updateSimulation();
        }
    }

    function updateSimulation() {
        // Mock function to update the bottom alert based on moves
        // Logic: specific config -> specific message
    }
</script>

<style>
    .mask-linear {
        mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    }

    .animate-slide-up {
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
</style>
{% endblock %}