{% extends "base.html" %}

{% block content %}
<div class="h-screen flex flex-col bg-slate-900 text-slate-100 font-sans overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 px-6 py-3 shrink-0">
        <div class="flex items-center justify-between">

            <!-- Left: Brand -->
            <div class="flex flex-col flex-1">
                <h1 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="text-blue-500 text-xl">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </span> Fluxo Operacional
                </h1>
                <p class="text-[10px] text-slate-400 font-medium tracking-wide">VISÃO EM TEMPO REAL</p>
            </div>

            <!-- Center: Context Controls (Date & Shift) -->
            <div
                class="flex items-center gap-4 bg-slate-900/80 p-1.5 rounded-2xl border border-slate-700/60 shadow-inner">

                <!-- Date Input -->
                <div class="relative group px-2">
                    <div class="absolute inset-y-0 left-2 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-slate-500 group-hover:text-blue-400 transition" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <input type="date" id="date-picker" value="{{ current_date }}" onchange="changeDate(this.value)"
                        class="bg-transparent text-white text-xs font-bold py-1.5 pl-8 pr-1 border-none focus:ring-0 cursor-pointer outline-none w-32 text-center tracking-wide hover:text-blue-200 transition"
                        onclick="this.showPicker()">
                </div>

                <div class="w-px h-5 bg-slate-700"></div>

                <!-- Shift Tabs -->
                <div class="flex p-0.5 bg-slate-800 rounded-xl" id="shift-controls">
                    <button onclick="changeShift('Manhã')" data-shift="Manhã"
                        class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300 hover:bg-slate-700/50">Manhã</button>
                    <button onclick="changeShift('Tarde')" data-shift="Tarde"
                        class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300 hover:bg-slate-700/50">Tarde</button>
                    <button onclick="changeShift('Noite')" data-shift="Noite"
                        class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300 hover:bg-slate-700/50">Noite</button>
                </div>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-2 flex-1 justify-end">
                <a href="/routine/report?date={{ current_date }}&shift={{ current_shift }}" id="report-link"
                    target="_blank"
                    class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg transition flex items-center gap-1.5 shadow-md">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Relatório
                </a>

                <button onclick="createSector()"
                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition flex items-center gap-1.5 shadow-md">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"
                        viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Setor
                </button>

                <button onclick="saveAll()"
                    class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition shadow-md">
                    Salvar
                </button>

                <button onclick="closeShift()"
                    class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded-lg transition shadow-md">
                    Encerrar
                </button>
            </div>

        </div>
    </header>

    <!-- KPI Strip -->
    <div id="kpi-strip" class="shrink-0 px-6 py-4 border-b border-slate-800 bg-slate-900/95 backdrop-blur z-10">
        <!-- Grid de 5 colunas responsivo -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">

            <!-- 1. Headcount -->
            <div onclick="KPIDetails.show('present')"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-emerald-500 transition">
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Headcount</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none">
                        <span id="total-present">0</span>
                        <span class="text-slate-600 text-sm">/ <span id="total-target-kpi">45</span></span>
                    </p>
                    <p class="text-[8px] text-slate-500 mt-1">
                        <span id="present-percent" class="text-emerald-400 font-bold">0%</span> presença
                    </p>
                </div>
            </div>

            <!-- 6. Vagas (Demitidos) -->
            <div onclick="KPIDetails.show('gap')"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-red-500 transition">
                <p class="text-[9px] font-bold text-red-400 uppercase mb-1">Vagas</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none" id="total-gap">0</p>
                    <p class="text-[8px] text-slate-500 mt-1">Demitidos</p>
                </div>
            </div>

            <!-- 3. Férias -->
            <div onclick="KPIDetails.show('vacation')"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-orange-500 transition">
                <p class="text-[9px] font-bold text-orange-400 uppercase mb-1">Férias</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none" id="total-vacation">0</p>
                    <p class="text-[8px] text-slate-500 mt-1">Colaboradores</p>
                </div>
            </div>

            <!-- 4. Afastados -->
            <div onclick="KPIDetails.show('away')"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-indigo-500 transition">
                <p class="text-[9px] font-bold text-indigo-400 uppercase mb-1">Afastados</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none" id="total-away">0</p>
                    <p class="text-[8px] text-slate-500 mt-1">Colaboradores</p>
                </div>
            </div>

            <!-- 5. Atestados -->
            <div onclick="KPIDetails.show('sick')"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-amber-500 transition">
                <p class="text-[9px] font-bold text-amber-400 uppercase mb-1">Atestados</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none" id="total-sick">0</p>
                    <p class="text-[8px] text-slate-500 mt-1">Colaboradores</p>
                </div>
            </div>

            <!-- 6. Faltas -->
            <div onclick="KPIDetails.show('missing')"
                class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-rose-500 transition">
                <p class="text-[9px] font-bold text-rose-400 uppercase mb-1">Faltas</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none" id="total-missing">0</p>
                    <p class="text-[8px] text-slate-500 mt-1">Colaboradores</p>
                </div>
            </div>

            <!-- 7. Produção Total -->
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-between cursor-pointer hover:border-purple-500 transition"
                onclick="editTonnage()">
                <p class="text-[9px] font-bold text-purple-400 uppercase mb-1">Produção</p>
                <div>
                    <p class="text-xl font-bold text-white leading-none" id="total-tonnage">0 kg</p>
                    <p class="text-[8px] text-slate-500 mt-1">
                        <span id="prod-per-person" class="text-purple-400 font-bold">0</span> kg/pessoa
                    </p>
                </div>
            </div>

        </div>
    </div>


    <!-- Main Content -->
    <main class="flex-1 overflow-hidden flex flex-col">
        <!-- Flow Grid -->
        <div class="flex-1 p-6 overflow-hidden">
            <div id="flow-grid"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 h-full auto-rows-max">
                <!-- Sectors will be rendered here by render.js -->
            </div>
        </div>
    </main>

</div>

<!-- Modal: Criar/Editar Setor -->
<div id="sector-crud-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" onclick="closeModal('sector-crud-modal')"></div>
    <div class="relative z-10 flex min-h-full items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-bold text-slate-100" id="sector-modal-title">Novo Setor</h3>
                <button onclick="closeModal('sector-crud-modal')" class="text-slate-400 hover:text-white">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="sector-form" class="p-4 space-y-4">
                <input type="hidden" id="sector-id" name="sector_id">

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Nome do Setor</label>
                    <input type="text" id="sector-name" name="name" required
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Limite de Vagas</label>
                    <input type="number" id="sector-max" name="max_employees" min="0" value="0"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Cor</label>
                    <select id="sector-color" name="color"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500">
                        <option value="blue">Azul</option>
                        <option value="green">Verde</option>
                        <option value="purple">Roxo</option>
                        <option value="orange">Laranja</option>
                        <option value="red">Vermelho</option>
                    </select>
                </div>
            </form>

            <div class="p-4 border-t border-slate-700 flex justify-end gap-2">
                <button onclick="closeModal('sector-crud-modal')"
                    class="px-4 py-2 text-sm text-slate-300 hover:text-white">Cancelar</button>
                <button onclick="saveSector()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Criar/Editar Sub-setor -->
<div id="subsector-crud-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" onclick="closeModal('subsector-crud-modal')"></div>
    <div class="relative z-10 flex min-h-full items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-bold text-slate-100" id="subsector-modal-title">Novo Sub-setor</h3>
                <button onclick="closeModal('subsector-crud-modal')" class="text-slate-400 hover:text-white">
                    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="subsector-form" class="p-4 space-y-4">
                <input type="hidden" id="subsector-id" name="subsector_id">
                <input type="hidden" id="subsector-sector-id" name="sector_id">

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Nome do Sub-setor</label>
                    <input type="text" id="subsector-name" name="name" required
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Limite de Vagas</label>
                    <input type="number" id="subsector-max" name="max_employees" min="0" value="0"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500">
                </div>
            </form>

            <div class="p-4 border-t border-slate-700 flex justify-end gap-2">
                <button onclick="closeModal('subsector-crud-modal')"
                    class="px-4 py-2 text-sm text-slate-300 hover:text-white">Cancelar</button>
                <button onclick="saveSubSector()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts Loader -->
<script>
    // Dados iniciais - carregados do backend
    window.INITIAL_DATA = {
        employees: [],
        sectors: [],
        tonnage: 0
    };

    // Carregar employees do backend via fetch imediato
    fetch('/api/employees')
        .then(r => r.json())
        .then(data => {
            window.INITIAL_DATA.employees = data.employees || [];
            console.log('Employees loaded:', window.INITIAL_DATA.employees.length);

            // Atualizar Store se já estiver inicializado
            if (window.Store && window.Store.state) {
                window.Store.state.employees = window.INITIAL_DATA.employees;
                window.Store.notify(); // Recalcular KPIs e atualizar UI
                console.log('Store updated with employees');
            }
        })
        .catch(err => console.error('Error loading employees:', err));
</script>

<!-- Modules -->
<script src="/static/js/smart-flow/api.js?v=20260102X"></script>
<script src="/static/js/smart-flow/store.js?v=20260102X"></script>
<script src="/static/js/smart-flow/sectors-crud.js?v=20260102X"></script>
<script src="/static/js/smart-flow/sector-management.js?v=20260102X"></script>
<script src="/static/js/smart-flow/kpi-details.js?v=20260102X"></script>
<script src="/static/js/smart-flow/render.js?v=20260102X"></script>
<script src="/static/js/smart-flow/events.js?v=20260102X"></script>
<script src="/static/js/smart-flow/main.js?v=20260102X"></script>

{% endblock %}