{% extends "base.html" %}

{% block content %}
<style>
    .flow-container {
        display: flex;
        gap: 1rem;
        padding: 2rem 1rem;
        align-items: stretch;
        min-height: 400px;
        width: 100%;
    }

    .flow-step {
        flex: 1;
        min-width: 0;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    /* Connector Lines - Dark Theme Color */
    .flow-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 50px;
        right: -1rem;
        /* Adjusted for smaller gap */
        width: 1rem;
        height: 2px;
        background: #475569;
        /* slate-600 */
        z-index: 0;
    }

    .flow-step:not(:last-child)::before {
        content: '';
        position: absolute;
        top: 46px;
        right: -1rem;
        width: 8px;
        height: 8px;
        border-top: 2px solid #475569;
        /* slate-600 */
        border-right: 2px solid #475569;
        /* slate-600 */
        transform: rotate(45deg);
        z-index: 1;
    }

    .sector-card {
        background: #1e293b;
        /* slate-800 */
        border: 1px solid #334155;
        /* slate-700 */
        border-radius: 12px;
        padding: 1rem;
        transition: all 0.2s;
        cursor: pointer;
        height: 100%;
        display: flex;
        flex-direction: column;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .sector-card:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    .sector-card.critical {
        border-left: 4px solid #ef4444;
    }

    .sector-card.ok {
        border-left: 4px solid #22c55e;
    }

    .modal-overlay {
        background-color: rgba(0, 0, 0, 0.7);
        transition: opacity 0.3s ease;
    }

    .subsector-dropzone {
        min-height: 100px;
        background: #0f172a;
        /* slate-900 */
        border: 2px dashed #334155;
        /* slate-700 */
        border-radius: 8px;
        margin-bottom: 1rem;
        padding: 0.5rem;
        transition: border-color 0.2s;
    }

    .subsector-dropzone:hover {
        border-color: #94a3b8;
    }

    .delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ef4444;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
    }

    .sector-card:hover .delete-btn {
        opacity: 1;
    }
</style>

<div class="flex flex-col h-full">
    <!-- Header -->
    <header
        class="bg-slate-800 border-b border-slate-700 px-6 py-4 flex justify-between items-center sticky top-0 z-10 shrink-0">
        <div>
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-blue-500">‚ö°</span> Fluxo Operacional
            </h1>
            <p class="text-xs text-slate-400 mt-1">Vis√£o em tempo real da opera√ß√£o e aloca√ß√£o de equipes</p>
        </div>

        <div class="flex items-center gap-4">
            <div class="bg-slate-900 rounded-lg p-1 flex text-xs font-semibold border border-slate-700">
                <button onclick="changeShift('Manh√£')"
                    class="px-3 py-1.5 rounded-md transition {{ 'bg-slate-700 text-blue-400 shadow-sm' if current_shift == 'Manh√£' else 'text-slate-500 hover:text-slate-300' }}">Manh√£</button>
                <button onclick="changeShift('Tarde')"
                    class="px-3 py-1.5 rounded-md transition {{ 'bg-slate-700 text-blue-400 shadow-sm' if current_shift == 'Tarde' else 'text-slate-500 hover:text-slate-300' }}">Tarde</button>
                <button onclick="changeShift('Noite')"
                    class="px-3 py-1.5 rounded-md transition {{ 'bg-slate-700 text-blue-400 shadow-sm' if current_shift == 'Noite' else 'text-slate-500 hover:text-slate-300' }}">Noite</button>
            </div>

            <button onclick="createSector()"
                class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-2 rounded-lg font-semibold text-xs flex items-center gap-2 transition border border-slate-600">
                <span>+</span> Novo Setor
            </button>

            <button onclick="saveRoutine()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition shadow-lg shadow-blue-500/30">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Salvar
            </button>
        </div>
    </header>

    <!-- KPI Bar -->
    <div class="px-6 py-4 grid grid-cols-2 md:grid-cols-4 gap-4 shrink-0">
        <!-- Headcount -->
        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase">Headcount Total</p>
                <p class="text-2xl font-bold text-white" id="total-present">0</p>
            </div>
            <div class="bg-blue-500/10 p-2 rounded-lg text-blue-400">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
        </div>

        <!-- Gap -->
        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase">Vagas em Aberto</p>
                <p class="text-2xl font-bold text-red-400" id="total-gap">0</p>
            </div>
            <div class="bg-red-500/10 p-2 rounded-lg text-red-400">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="18" y1="8" x2="23" y2="13"></line>
                    <line x1="23" y1="8" x2="18" y2="13"></line>
                </svg>
            </div>
        </div>

        <!-- Absenteeism -->
        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase">Absente√≠smo</p>
                <p class="text-2xl font-bold text-orange-400" id="total-absent">0%</p>
            </div>
            <div class="bg-orange-500/10 p-2 rounded-lg text-orange-400">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
        </div>

        <!-- Tonnage -->
        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase">Produ√ß√£o (Kg)</p>
                <p class="text-2xl font-bold text-emerald-400" id="total-tonnage">{{ daily_op.tonnage }} kg</p>
            </div>
            <div class="bg-emerald-500/10 p-2 rounded-lg text-emerald-400">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
            </div>
        </div>
    </div>

    <!-- Main Flow -->
    <div class="flow-container flex-1" id="flow-grid">
        <!-- Rendered by JS -->
    </div>
</div>

<!-- Manager Modal -->
<div id="checkin-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
            class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-slide-up border border-slate-700">

            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500/10 p-2 rounded-lg text-blue-400">
                        <!-- Icon -->
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white" id="modal-title">Gerenciar Setor</h2>
                        <p class="text-xs text-slate-400">Distribua a equipe nos sub-setores</p>
                    </div>
                </div>
                <button onclick="closeModal()"
                    class="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-red-400 transition"
                    aria-label="Fechar Modal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-hidden flex divide-x divide-slate-700">

                <!-- Left: Available Pool -->
                <div class="w-1/3 bg-slate-900 flex flex-col">
                    <div class="p-4 border-b border-slate-700 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Banco de Talentos
                            </h3>
                            <label class="flex items-center gap-2 cursor-pointer"
                                title="Mostrar funcion√°rios de outros turnos">
                                <input type="checkbox" id="show-all-toggle" onchange="filterEmployees()"
                                    class="rounded text-blue-600 focus:ring-blue-500 border-slate-600 bg-slate-800">
                                <span class="text-xs text-slate-500 select-none">Mostrar Todos</span>
                            </label>
                        </div>
                        <div class="relative">
                            <svg class="absolute left-3 top-2.5 text-slate-500" width="16" height="16"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="search-input" onkeyup="filterEmployees()"
                                placeholder="Buscar nome ou matr√≠cula..."
                                class="w-full pl-9 pr-4 py-2 text-sm bg-slate-800 border border-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-slate-500">
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2" id="available-list">
                        <!-- Items -->
                    </div>
                </div>

                <!-- Right: Active Subsectors -->
                <div class="flex-1 bg-slate-800 flex flex-col">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Equipe Alocada</h3>

                        <div class="flex items-center gap-2">
                            <span
                                class="bg-emerald-500/10 text-emerald-400 text-xs px-2 py-1 rounded-full font-bold border border-emerald-500/20"
                                id="active-count">0 Presentes</span>
                            <button onclick="createSubsector()"
                                class="text-blue-400 text-xs font-bold hover:underline px-2 py-1 rounded hover:bg-slate-700 transition"
                                title="Criar nova equipe ou linha">+ Novo Sub-setor</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4" id="subsectors-container">
                        <!-- Rendered Subsectors -->
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Allocation Selection Modal -->
<div id="allocation-modal" class="fixed inset-0 z-[60] hidden">
    <div class="modal-overlay absolute inset-0 backdrop-blur-sm" onclick="closeAllocationModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
            class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm border border-slate-700 overflow-hidden animate-slide-up">
            <div class="p-4 border-b border-slate-700 bg-slate-900/50">
                <h3 class="text-lg font-bold text-white">Alocar Colaborador</h3>
                <p class="text-xs text-slate-400">Escolha a equipe de destino</p>
            </div>
            <div class="p-4 flex flex-col gap-2" id="allocation-options">
                <!-- Options rendered dynamically -->
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-900/30 flex justify-end">
                <button onclick="closeAllocationModal()"
                    class="text-slate-400 hover:text-white text-sm font-medium">Cancelar</button>
            </div>
        </div>
    </div>
</div>


<script>
    // --- State ---
    let currentShift = "{{ current_shift }}";
    let shiftTargetHr = {{ shift_target_hr }};

    // Dynamic Config from Backend
    let config = {{ sector_config | tojson }};
    let SECTORS = config.sectors || [];

    let employees = {
        log: {{ daily_op.attendance_log | tojson }} 
    };

    const ALL_EMPLOYEES = [
        {% for emp in employees_list %}
    {
        id: "{{ emp.registration_id }}",
            name: "{{ emp.name }}",
                role: "{{ emp.role }}",
                    shift: "{{ emp.work_shift }}",
                        cost_center: "{{ emp.cost_center }}"
    },
    {% endfor %}
    ];

    let currentSectorKey = null;

    // --- Helpers ---
    function normalizeStr(str) {
        if (!str) return "";
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        renderFlow();
        updateKPIs();
    });

    // --- Core Rendering ---
    function renderFlow() {
        const container = document.getElementById('flow-grid');
        container.innerHTML = '';

        SECTORS.forEach((sec, idx) => {
            const sectorData = getSectorStats(sec.key);
            const statusClass = sectorData.deficit > 0 ? 'critical' : 'ok';
            // Dark theme classes embedded in JS
            const card = document.createElement('div');
            card.className = 'flow-step';
            card.innerHTML = `
                <div class="sector-card ${statusClass}" onclick="openModal('${sec.key}')" role="button" tabindex="0" title="Gerenciar ${sec.label}">
                    <button onclick="event.stopPropagation(); deleteSector(${idx})" class="delete-btn" title="Excluir Setor" aria-label="Excluir Setor">‚úï</button>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-white">${sec.label}</h3>
                            <div class="flex items-center gap-1 text-xs text-slate-400 group">
                                <span>Meta: ${sec.target || 0}</span>
                            </div>
                        </div>
                        <span onclick="event.stopPropagation(); editMeta(${idx})" class="text-xs font-bold px-2 py-1 rounded bg-slate-700 text-slate-300 border border-slate-600 cursor-pointer hover:bg-slate-600 transition" title="Editar Meta">${sectorData.count}/${sec.target || 0}</span>
                    </div>
                    
                    <div class="mt-auto">
                        <div class="w-full bg-slate-700 rounded-full h-2 mb-2 overflow-hidden">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(100, (sectorData.count / (sec.target || 1)) * 100)}%"></div>
                        </div>
                        ${sectorData.deficit > 0
                    ? `<p class="text-xs font-bold text-red-400 flex items-center gap-1">‚ö†Ô∏è Faltam ${sectorData.deficit}</p>`
                    : `<p class="text-xs font-bold text-emerald-400 flex items-center gap-1">‚ú® Completo</p>`
                }
                    </div>
                    
                    <div class="flex -space-x-2 mt-4 overflow-hidden py-1">
                         ${sectorData.people.slice(0, 5).map(p => `
                            <div class="w-6 h-6 rounded-full bg-blue-500/20 border-2 border-slate-800 flex items-center justify-center text-[10px] font-bold text-blue-400" title="${p.name}">
                                ${p.name.charAt(0)}
                            </div>
                         `).join('')}
                         ${sectorData.people.length > 5 ? `<div class="w-6 h-6 rounded-full bg-slate-700 border-2 border-slate-800 flex items-center justify-center text-[10px] text-slate-400">+${sectorData.people.length - 5}</div>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function getSectorStats(sectorKey) {
        const sectorConfig = SECTORS.find(s => s.key === sectorKey);
        const target = sectorConfig ? (sectorConfig.target || 0) : 0;

        const people = Object.entries(employees.log)
            .filter(([_, entry]) => entry.sector === sectorKey && entry.status === 'present')
            .map(([id, entry]) => ({ ...entry, id }));

        return {
            count: people.length,
            people: people,
            target: target,
            deficit: Math.max(0, target - people.length)
        };
    }

    function updateKPIs() {
        let present = 0;
        let absent = 0;
        const logEntries = Object.values(employees.log);

        logEntries.forEach(e => {
            if (e.status === 'present') present++;
            if (e.status === 'absent') absent++;
        });

        // Calculate Operational Gap based on Headcount Target (User Request)
        const totalSectorTarget = SECTORS.reduce((acc, s) => acc + (s.target || 0), 0);
        const finalTarget = shiftTargetHr > 0 ? shiftTargetHr : totalSectorTarget;

        document.getElementById('total-present').innerText = present;
        document.getElementById('total-gap').innerText = Math.max(0, finalTarget - present);

        const totalMarked = logEntries.length;
        const absRate = totalMarked > 0 ? ((absent / totalMarked) * 100).toFixed(1) : 0;
        document.getElementById('total-absent').innerText = absRate + '%';
    }

    // --- Modal & Listings ---
    function openModal(sectorKey) {
        currentSectorKey = sectorKey;
        const sector = SECTORS.find(s => s.key === sectorKey);
        document.getElementById('modal-title').innerText = sector.label;
        document.getElementById('checkin-modal').classList.remove('hidden');

        renderAvailableList();
        renderActiveList();
    }

    function closeModal() {
        document.getElementById('checkin-modal').classList.add('hidden');
        renderFlow();
        updateKPIs();
    }

    function renderAvailableList(filter = "") {
        const list = document.getElementById('available-list');
        list.innerHTML = '';

        const showAll = document.getElementById('show-all-toggle').checked;

        // Normalize current shift once
        const curShiftNorm = normalizeStr(currentShift);

        const candidates = ALL_EMPLOYEES.filter(emp => {
            const isAllocated = employees.log[emp.id];
            const matchesFilter = emp.name.toLowerCase().includes(filter.toLowerCase()) || emp.id.includes(filter);
            const empShiftNorm = normalizeStr(emp.shift || "");

            // Flexible matching: exact match OR showAll
            const matchesShift = showAll || (empShiftNorm === curShiftNorm);

            return !isAllocated && matchesFilter && matchesShift;
        }).slice(0, 50);

        candidates.forEach(emp => {
            const empShift = (emp.shift || "N/A").trim();
            const curShift = (currentShift || "").trim();

            // Warning logic uses same robust check
            const isWrongShift = normalizeStr(empShift) !== normalizeStr(curShift);

            // Extra warning logic
            const warningHtml = isWrongShift
                ? `<span class="bg-amber-500/20 text-amber-400 text-[10px] px-1.5 py-0.5 rounded font-bold ml-2 border border-amber-500/30" title="Turno original: ${empShift}">‚ö†Ô∏è ${empShift}</span>`
                : '';

            // Show Cost Center for context (Dark)
            const ccBadges = emp.cost_center ? `<span class="text-[9px] bg-slate-700 rounded px-1 ml-1 text-slate-400 border border-slate-600">${emp.cost_center}</span>` : '';

            const el = document.createElement('div');
            el.className = "bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-sm flex justify-between items-center group hover:border-blue-500/50 transition mb-2";
            el.innerHTML = `
                <div class="flex-1 overflow-hidden">
                    <div class="flex items-center flex-wrap gap-1">
                         <p class="text-sm font-semibold text-slate-200 truncate">${emp.name}</p>
                         ${warningHtml}
                    </div>
                    <div class="flex items-center mt-1">
                        <p class="text-xs text-slate-500 truncate">Mat: ${emp.id}</p>
                        ${ccBadges}
                    </div>
                </div>
                <button onclick="addToSector('${emp.id}', '${emp.name}')" class="bg-slate-700 text-blue-400 p-1.5 rounded-md hover:bg-slate-600 hover:text-white transition shrink-0 ml-2" aria-label="Adicionar ${emp.name}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                </button>
            `;
            list.appendChild(el);
        });

        if (candidates.length === 0) {
            list.innerHTML = `<div class="text-center p-4 text-xs text-slate-500">Nenhum colaborador encontrado. ${!showAll ? '<br>Tente "Mostrar Todos".' : ''}</div>`;
        }
    }

    function renderActiveList() {
        const container = document.getElementById('subsectors-container');
        container.innerHTML = '';

        const sector = SECTORS.find(s => s.key === currentSectorKey);
        const activeInSector = Object.entries(employees.log)
            .filter(([_, entry]) => entry.sector === currentSectorKey)
            .map(([id, entry]) => ({ ...entry, id }));

        const usedSubsectors = new Set(activeInSector.map(p => p.subsector || 'Geral'));
        if (sector.subsectors && Array.isArray(sector.subsectors)) {
            sector.subsectors.forEach(s => usedSubsectors.add(s));
        }

        // Collect groups
        const grouped = {};
        usedSubsectors.forEach(sub => grouped[sub] = []);

        activeInSector.forEach(p => {
            const sub = p.subsector || 'Geral';
            if (!grouped[sub]) grouped[sub] = []; // Just in case
            grouped[sub].push(p);
        });

        document.getElementById('active-count').innerText = `${activeInSector.filter(p => p.status === 'present').length} Presentes`;

        Object.entries(grouped).forEach(([subName, people]) => {
            const groupEl = document.createElement('div');
            groupEl.className = 'mb-6';
            groupEl.innerHTML = `
                <div class="flex items-center gap-2 mb-3 group">
                    <h4 class="text-xs font-bold text-slate-400 uppercase flex items-center gap-2">
                        ${subName} 
                        <span class="bg-slate-700 text-slate-300 px-1.5 rounded text-[10px]">${people.length}</span>
                    </h4>
                    <div class="opacity-0 group-hover:opacity-100 flex items-center gap-1 transition">
                        <button onclick="renameSubsector('${subName}')" class="text-slate-500 hover:text-blue-400 text-xs p-1" title="Renomear">‚úé</button>
                        ${subName !== 'Geral' ? `<button onclick="deleteSubsector('${subName}')" class="text-slate-500 hover:text-red-400 text-xs p-1" title="Excluir Sub-setor" aria-label="Excluir">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
                
                <div class="subsector-dropzone" ondragover="allowDrop(event)" ondrop="drop(event, '${subName}')">
                    ${people.length === 0 ? '<p class="text-xs text-slate-500 text-center py-4">Arraste ou adicione aqui</p>' : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                         ${people.map(p => `
                            <div class="bg-slate-800 border border-slate-700 rounded-lg p-2 flex items-center justify-between shadow-sm cursor-grab" draggable="true" ondragstart="drag(event, '${p.id}')">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-400 shrink-0 border border-slate-600">${p.name.charAt(0)}</div>
                                    <div class="overflow-hidden">
                                        <p class="text-sm font-medium text-slate-200 leading-tight truncate">${p.name}</p>
                                        <div class="flex gap-1 mt-1">
                                            ${renderStatusBadge(p.status)}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-1 shrink-0">
                                     <button onclick="setStatus('${p.id}', 'present')" class="p-1 rounded hover:bg-emerald-500/20 text-slate-500 hover:text-emerald-400 ${p.status === 'present' ? 'text-emerald-400 bg-emerald-500/10' : ''}" title="Presente">P</button>
                                     <button onclick="setStatus('${p.id}', 'absent')" class="p-1 rounded hover:bg-red-500/20 text-slate-500 hover:text-red-400 ${p.status === 'absent' ? 'text-red-400 bg-red-500/10' : ''}" title="Falta">F</button>
                                     <button onclick="setStatus('${p.id}', 'sick')" class="p-1 rounded hover:bg-cyan-500/20 text-slate-500 hover:text-cyan-400 ${p.status === 'sick' ? 'text-cyan-400 bg-cyan-500/10' : ''}" title="Atestado">A</button>
                                     <button onclick="setStatus('${p.id}', 'vacation')" class="p-1 rounded hover:bg-orange-500/20 text-slate-500 hover:text-orange-400 ${p.status === 'vacation' ? 'text-orange-400 bg-orange-500/10' : ''}" title="F√©rias">F√©</button>
                                     <button onclick="setStatus('${p.id}', 'away')" class="p-1 rounded hover:bg-purple-500/20 text-slate-500 hover:text-purple-400 ${p.status === 'away' ? 'text-purple-400 bg-purple-500/10' : ''}" title="Afastado">Af</button>
                                     <button onclick="removeFromSector('${p.id}')" class="p-1 rounded hover:bg-slate-700 text-slate-500 hover:text-red-400 ml-1" title="Remover">‚úï</button>
                                </div>
                            </div>
                         `).join('')}
                    </div>
                </div>
            `;
            container.appendChild(groupEl);
        });
    }

    // --- Configuration Editing ---

    function deleteSubsector(subName) {
        if (subName === 'Geral') return; // Cannot delete default
        if (!confirm(`Tem certeza que deseja excluir a equipe "${subName}"?\nOs colaboradores voltar√£o para "Geral".`)) return;

        const sector = SECTORS.find(s => s.key === currentSectorKey);
        if (sector && sector.subsectors) {
            const idx = sector.subsectors.indexOf(subName);
            if (idx !== -1) {
                sector.subsectors.splice(idx, 1);

                // Move employees to 'Geral'
                Object.keys(employees.log).forEach(id => {
                    const entry = employees.log[id];
                    if (entry.sector === currentSectorKey && entry.subsector === subName) {
                        entry.subsector = 'Geral';
                    }
                });

                renderActiveList();
            }
        }
    }

    function createSector() {
        const name = prompt("Nome do novo setor:");
        if (!name) return;

        const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
        SECTORS.push({
            key: key,
            label: name,
            target: 0,
            subsectors: ['Geral']
        });
        renderFlow();
        updateKPIs();
    }

    function deleteSector(index) {
        if (confirm("Tem certeza que deseja excluir este setor?")) {
            SECTORS.splice(index, 1);
            renderFlow();
            updateKPIs();
        }
    }

    function editMeta(index) {
        const current = SECTORS[index].target || 0;
        const newVal = prompt("Nova Meta:", current);
        if (newVal && !isNaN(newVal)) {
            SECTORS[index].target = parseInt(newVal);
            renderFlow();
            updateKPIs();
        }
    }

    function createSubsector() {
        const name = prompt("Nome do novo sub-setor:");
        if (!name) return;

        // Safer way to get sector ref
        const sectorIndex = SECTORS.findIndex(s => s.key === currentSectorKey);
        if (sectorIndex === -1) return;

        const sector = SECTORS[sectorIndex];

        if (!sector.subsectors || !Array.isArray(sector.subsectors)) {
            sector.subsectors = ['Geral'];
        }

        if (!sector.subsectors.includes(name)) {
            sector.subsectors.push(name);
            // Important: Update the global config immediately in memory?
            // Yes, SECTORS is a ref.

            // Re-render
            renderActiveList();
        }
    }

    function renameSubsector(oldName) {
        const newName = prompt("Renomear equipe " + oldName + " para:", oldName);
        if (newName && newName !== oldName) {
            // Update Config
            const sector = SECTORS.find(s => s.key === currentSectorKey);
            if (sector.subsectors) {
                const idx = sector.subsectors.indexOf(oldName);
                if (idx !== -1) sector.subsectors[idx] = newName;
                else sector.subsectors.push(newName); // If it was transient
            }

            // Update Employees
            Object.keys(employees.log).forEach(id => {
                const entry = employees.log[id];
                if (entry.sector === currentSectorKey && (entry.subsector === oldName || (!entry.subsector && oldName === 'Geral'))) {
                    entry.subsector = newName;
                }
            });
            renderActiveList();
        }
    }


    // --- Interaction ---

    function filterEmployees() {
        renderAvailableList(document.getElementById('search-input').value);
    }

    let pendingAllocation = null; // Store {id, name} for simple add

    function addToSector(id, name, subsector = null) {
        if (!subsector) {
            const sector = SECTORS.find(s => s.key === currentSectorKey);
            const subs = sector.subsectors || ['Geral'];

            // === Allocation Logic ===
            if (subs.length > 1) {
                // Open Selection Modal
                pendingAllocation = { id, name };
                openAllocationModal(subs);
                return;
            } else {
                // Default to first (usually Geral)
                subsector = subs.length > 0 ? subs[0] : 'Geral';
            }
        }

        // Proceed to allocate
        employees.log[id] = {
            status: 'present',
            sector: currentSectorKey,
            subsector: subsector,
            name: name
        };

        renderAvailableList(document.getElementById('search-input').value);
        renderActiveList();
        updateKPIs();
    }

    function openAllocationModal(subsectors) {
        const container = document.getElementById('allocation-options');
        container.innerHTML = '';

        subsectors.forEach(sub => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition border border-slate-600 flex justify-between items-center group";
            btn.innerHTML = `
                <span class="font-medium">${sub}</span>
                <span class="text-xs text-slate-400 group-hover:text-blue-400">Selecionar &rarr;</span>
            `;
            btn.onclick = () => {
                addToSector(pendingAllocation.id, pendingAllocation.name, sub);
                closeAllocationModal();
            };
            container.appendChild(btn);
        });

        document.getElementById('allocation-modal').classList.remove('hidden');
    }

    function closeAllocationModal() {
        document.getElementById('allocation-modal').classList.add('hidden');
        pendingAllocation = null;
    }

    function removeFromSector(id) {
        delete employees.log[id];
        renderAvailableList(document.getElementById('search-input').value);
        renderActiveList();
        updateKPIs();
    }

    function setStatus(id, status) {
        if (employees.log[id]) {
            employees.log[id].status = status;
            renderActiveList();
            updateKPIs();
        }
    }

    function changeShift(shift) {
        window.location.href = `/smart-flow?shift=${shift}`;
    }

    function drag(ev, id) {
        ev.dataTransfer.setData("text", id);
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drop(ev, targetSubsector) {
        ev.preventDefault();
        const id = ev.dataTransfer.getData("text");
        if (employees.log[id]) {
            employees.log[id].subsector = targetSubsector;
            renderActiveList();
        }
    }

    function renderStatusBadge(status) {
        if (status === 'present') return '<span class="text-[10px] text-emerald-400">Presente</span>';
        if (status === 'absent') return '<span class="text-[10px] text-red-400">Falta</span>';
        if (status === 'sick') return '<span class="text-[10px] text-cyan-400">Atestado</span>';
        if (status === 'vacation') return '<span class="text-[10px] text-orange-400">F√©rias</span>';
        if (status === 'away') return '<span class="text-[10px] text-purple-400">Afastado</span>';
        return '<span class="text-[10px] text-slate-500">Desconhecido</span>';
    }

    // --- Save ---
    async function saveRoutine() {
        // Update config inside payload
        config.sectors = SECTORS;

        const payload = {
            date: new Date().toISOString().split('T')[0],
            shift: currentShift,
            attendance_log: employees.log,
            sector_config: config
        };

        try {
            const res = await fetch('/routine/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) alert('Salvo e Sincronizado com Sucesso!');
            else alert('Erro ao salvar');
        } catch (e) {
            console.error(e);
            alert('Erro de conex√£o');
        }
    }

</script>
{% endblock %}